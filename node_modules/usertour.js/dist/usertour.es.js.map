{"version":3,"file":"usertour.es.js","sources":["../src/detect-browser-target.ts","../src/usertour.ts"],"sourcesContent":["type BrowserTarget = 'es2020' | 'legacy'\n\n/**\n * Returns `es2020` if the browser supports ES2020 features, `legacy` otherwise.\n *\n * It would be better to detect features, but there's no way to test e.g. if\n * dynamic imports are available in containing apps that may prevent `eval` via\n * their Content-Security-Policy.\n *\n * It's important that we don't mistake a legacy browser as es2020 (since that\n * may cause us to run an incompatible version), but it's okay to mistake an\n * es2020-capable browser and serve them the legacy version.\n *\n * The browser version numbers are based off of caniuse.com data of browsers\n * supporting ALL of the the following features:\n * - https://caniuse.com/es6-module-dynamic-import\n * - https://caniuse.com/mdn-javascript_operators_nullish_coalescing\n * - https://caniuse.com/mdn-javascript_operators_optional_chaining\n * - https://caniuse.com/bigint\n * - https://caniuse.com/mdn-javascript_builtins_promise_allsettled\n * - https://caniuse.com/mdn-javascript_builtins_globalthis\n * - https://caniuse.com/mdn-javascript_builtins_string_matchall\n */\nexport function detectBrowserTarget(agent: string): BrowserTarget {\n  var options: [RegExp, RegExp, number][] = [\n    // Edge. Can contain \"Chrome\", so must come before Chrome.\n    [/Edg\\//, /Edg\\/(\\d+)/, 80],\n    // Opera. Can contain \"Chrome\", so must come before Chrome\n    [/OPR\\//, /OPR\\/(\\d+)/, 67],\n    // Chrome. Can contain \"Safari\", so must come before Safari.\n    [/Chrome\\//, /Chrome\\/(\\d+)/, 80],\n    // Chrome on iOS. Can contain \"Safari\", so must come before Safari.\n    // I'm not sure exactly what the engine driving Chrome iOS is, but assuming\n    // it's based on iOS Safari, which hit v14 (that's es2020 compatible) on\n    // September 16, 2020, and CriOS apparently hit v100 in April 11, 2022, we\n    // just go with 100.\n    [/CriOS\\//, /CriOS\\/(\\d+)/, 100],\n    // Safari\n    [/Safari\\//, /Version\\/(\\d+)/, 14],\n    // Firefox\n    [/Firefox\\//, /Firefox\\/(\\d+)/, 74]\n  ]\n  for (var i = 0; i < options.length; i++) {\n    var option = options[i]\n    var browserRegExp = option[0]\n    var versionRegExp = option[1]\n    var minVersion = option[2]\n    if (!agent.match(browserRegExp)) {\n      // No this browser\n      continue\n    }\n    // Must be this browser, so version has to be found and be greater than\n    // minVersion, otherwise we'll fall back to `legacy`.\n    var versionMatch = agent.match(new RegExp(versionRegExp))\n    if (versionMatch) {\n      var version = parseInt(versionMatch[1], 10)\n      if (version >= minVersion) {\n        return 'es2020'\n      }\n    }\n    break\n  }\n  return 'legacy'\n}\n","import type {ConditionalKeys} from 'type-fest'\nimport {detectBrowserTarget} from './detect-browser-target'\n\ninterface WindowWithUsertour extends Window {\n  usertour?: Usertour\n\n  USERTOURJS_QUEUE?: [string, Deferred | null, any[]][]\n  USERTOURJS_ENV_VARS?: Record<string, any>\n}\n\nexport interface Usertour {\n  _stubbed: boolean\n\n  load: () => Promise<void>\n\n  init: (token: string) => void\n\n  identify: (\n    userId: string,\n    attributes?: Attributes,\n    opts?: IdentifyOptions\n  ) => Promise<void>\n\n  identifyAnonymous: (\n    attributes?: Attributes,\n    opts?: IdentifyOptions\n  ) => Promise<void>\n\n  updateUser: (attributes: Attributes, opts?: IdentifyOptions) => Promise<void>\n\n  group: (\n    groupId: string,\n    attributes?: Attributes,\n    opts?: GroupOptions\n  ) => Promise<void>\n\n  updateGroup: (attributes: Attributes, opts?: GroupOptions) => Promise<void>\n\n  track(\n    name: string,\n    attributes?: EventAttributes,\n    opts?: TrackOptions\n  ): Promise<void>\n\n  isIdentified: () => boolean\n\n  start: (contentId: string, opts?: StartOptions) => Promise<void>\n\n  isStarted: (contentId: string) => boolean\n\n  endAll: () => Promise<void>\n\n  reset: () => void\n\n  remount: () => void\n\n  // eslint-disable-next-line es5/no-rest-parameters\n  on(eventName: string, listener: (...args: any[]) => void): void\n\n  // eslint-disable-next-line es5/no-rest-parameters\n  off(eventName: string, listener: (...args: any[]) => void): void\n\n  setCustomInputSelector(customInputSelector: string | null): void\n\n  registerCustomInput(\n    cssSelector: string,\n    getValue?: (el: Element) => string\n  ): void\n\n  setCustomNavigate(customNavigate: ((url: string) => void) | null): void\n\n  setUrlFilter(urlFilter: ((url: string) => string) | null): void\n\n  setLinkUrlDecorator(linkUrlDecorator: ((url: string) => string) | null): void\n\n  setInferenceAttributeNames(attributeNames: string[]): void\n\n  setInferenceAttributeFilter(\n    attributeName: string,\n    filters: StringFilters\n  ): void\n\n  setInferenceClassNameFilter(filters: StringFilters): void\n\n  setScrollPadding(scrollPadding: ScrollPadding | null): void\n\n  setCustomScrollIntoView(scrollIntoView: ((el: Element) => void) | null): void\n\n  _setTargetEnv(targetEnv: unknown): void\n\n  setShadowDomEnabled(shadowDomEnabled: boolean): void\n\n  setPageTrackingDisabled(pageTrackingDisabled: boolean): void\n\n  setBaseZIndex(baseZIndex: number): void\n\n  setSessionTimeout(hours: number): void\n\n  setTargetMissingSeconds(seconds: number): void\n\n  setServerEndpoint(serverEndpoint: string | null | undefined): void\n\n  disableEvalJs(): void\n}\n\nexport interface Attributes {\n  [name: string]: AttributeLiteralOrList | AttributeChange\n}\n\ntype AttributeLiteral = string | number | boolean | null | undefined\ntype AttributeLiteralOrList = AttributeLiteral | AttributeLiteral[]\n\ninterface AttributeChange {\n  set?: AttributeLiteralOrList\n  set_once?: AttributeLiteralOrList\n  add?: string | number\n  subtract?: string | number\n  append?: AttributeLiteralOrList\n  prepend?: AttributeLiteralOrList\n  remove?: AttributeLiteralOrList\n  data_type?: AttributeDataType\n}\n\ntype AttributeDataType = 'string' | 'boolean' | 'number' | 'datetime' | 'list'\n\nexport type IdentifyOptions = {\n  signature?: string\n}\n\nexport interface GroupOptions {\n  signature?: string\n  membership?: Attributes\n}\n\nexport interface EventAttributes {\n  [name: string]: AttributeLiteral | EventAttributeChange\n}\n\ninterface EventAttributeChange {\n  set?: AttributeLiteral\n  data_type?: AttributeDataType\n}\n\nexport interface TrackOptions {\n  userOnly?: boolean\n}\n\nexport interface StartOptions {\n  once?: boolean\n  continue?: boolean\n}\n\nexport interface ResourceCenterState {\n  isOpen: boolean\n  hasChecklist: boolean\n  uncompletedChecklistTaskCount: number\n  unreadAnnouncementCount: number\n}\n\ninterface ScrollPadding {\n  top?: number\n  right?: number\n  bottom?: number\n  left?: number\n}\n\ntype StringFilter = ((className: string) => boolean) | RegExp\n\ntype StringFilters = StringFilter | StringFilter[]\n\ninterface Deferred {\n  resolve: () => void\n  reject: (e: any) => void\n}\n\nvar w: WindowWithUsertour = typeof window === 'undefined' ? ({} as any) : window\nvar usertour = w.usertour\n\nconsole.log('enter npm backage, usertour:', usertour)\nif (!usertour) {\n  //\n  var urlPrefix = 'https://js.usertour.io/'\n  console.log('enter npm backage: ', urlPrefix)\n\n  // Initialize as an empty object (methods will be stubbed below)\n  var loadPromise: Promise<void> | null = null\n  usertour = w.usertour = {\n    _stubbed: true,\n    // Helper to inject the proper Usertour.js script/module into the document\n    load: function (): Promise<void> {\n      // Make sure we only load Usertour.js once\n      if (!loadPromise) {\n        loadPromise = new Promise(function (resolve, reject) {\n          var script = document.createElement('script')\n          script.async = true\n          // Detect if the browser supports es2020\n          var envVars = w.USERTOURJS_ENV_VARS || {}\n          var browserTarget =\n            envVars.USERTOURJS_BROWSER_TARGET ||\n            detectBrowserTarget(navigator.userAgent)\n          if (browserTarget === 'es2020') {\n            script.type = 'module'\n            script.src =\n              envVars.USERTOURJS_ES2020_URL || urlPrefix + 'es2020/usertour.js'\n          } else {\n            script.src =\n              envVars.USERTOURJS_LEGACY_URL ||\n              urlPrefix + 'legacy/usertour.iife.js'\n          }\n          script.onload = function () {\n            resolve()\n          }\n          script.onerror = function () {\n            document.head.removeChild(script)\n            loadPromise = null\n            var e = new Error('Could not load Usertour.js')\n            console.warn(e.message)\n            reject(e)\n          }\n          document.head.appendChild(script)\n        })\n      }\n      return loadPromise\n    }\n  } as Usertour\n\n  // Initialize the queue, which will be flushed by Usertour.js when it loads\n  var q = (w.USERTOURJS_QUEUE = w.USERTOURJS_QUEUE || [])\n\n  /**\n   * Helper to stub void-returning methods that should be queued\n   */\n  var stubVoid = function (\n    // eslint-disable-next-line es5/no-rest-parameters\n    method: ConditionalKeys<Usertour, (...args: any[]) => void>\n  ) {\n    // @ts-ignore\n    usertour![method] = function () {\n      var args = Array.prototype.slice.call(arguments)\n      usertour!.load()\n      q.push([method, null, args])\n    } as any\n  }\n\n  // Helper to stub promise-returning methods that should be queued\n  var stubPromise = function (\n    // eslint-disable-next-line es5/no-rest-parameters\n    method: ConditionalKeys<Usertour, (...args: any[]) => Promise<void>>\n  ) {\n    // @ts-ignore\n    usertour![method] = function () {\n      var args = Array.prototype.slice.call(arguments)\n      usertour!.load()\n      var deferred: Deferred\n      var promise = new Promise<void>(function (resolve, reject) {\n        deferred = {resolve: resolve, reject: reject}\n      })\n      q.push([method, deferred!, args])\n      return promise\n    } as any\n  }\n\n  // Helper to stub methods that MUST return a value synchronously, and\n  // therefore must support using a default callback until Usertour.js is\n  // loaded.\n  var stubDefault = function (\n    method: ConditionalKeys<Usertour, (...args: any[]) => any>,\n    returnValue: any\n  ) {\n    // @ts-ignore\n    usertour![method] = function () {\n      return returnValue\n    }\n  }\n\n  // Methods that return void and should be queued\n  stubVoid('init')\n  stubVoid('off')\n  stubVoid('on')\n  stubVoid('reset')\n  stubVoid('setBaseZIndex')\n  stubVoid('setSessionTimeout')\n  stubVoid('setTargetMissingSeconds')\n  stubVoid('setCustomInputSelector')\n  stubVoid('setCustomNavigate')\n  stubVoid('setCustomScrollIntoView')\n  stubVoid('setInferenceAttributeFilter')\n  stubVoid('setInferenceAttributeNames')\n  stubVoid('setInferenceClassNameFilter')\n  stubVoid('setScrollPadding')\n  stubVoid('setServerEndpoint')\n  stubVoid('setShadowDomEnabled')\n  stubVoid('setPageTrackingDisabled')\n  stubVoid('setUrlFilter')\n  stubVoid('setLinkUrlDecorator')\n\n  // Methods that return promises and should be queued\n  stubPromise('endAll')\n  stubPromise('group')\n  stubPromise('identify')\n  stubPromise('identifyAnonymous')\n  stubPromise('start')\n  stubPromise('track')\n  stubPromise('updateGroup')\n  stubPromise('updateUser')\n\n  // Methods that synchronously return and can be stubbed with default return\n  // values and are not queued\n  stubDefault('isIdentified', false)\n  stubDefault('isStarted',  false)\n}\n\nexport default usertour!\n"],"names":[],"mappings":"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"}